<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Interactive Chat Application</title>
    <style>
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: auto;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }

        #chat {
            flex: 1;
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 5px;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            scroll-behavior: smooth;
        }

        #chat::-webkit-scrollbar {
            width: 8px;
        }

        #chat::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }

        #chat::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 5px;
        }

        .message {
            margin: 8px 0;
            display: flex;
            flex-direction: column;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .bubble {
            display: inline-block;
            padding: 10px;
            border-radius: 15px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            color: #333;
            box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.1);
            max-width: 80%;
            width: auto;
        }

        .sent {
            align-self: flex-end;
            text-align: right;
        }

        .received {
            align-self: flex-start;
            text-align: left;
        }

        .timestamp {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }

        #input-area {
            display: flex;
        }

        #message {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 5px;
            box-sizing: border-box;
        }

        #send {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: #fff;
            cursor: pointer;
        }

        #send:hover {
            background: #0056b3;
        }

        #nameModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #nameModalContent {
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        #nameInput,
        #roomInput {
            padding: 8px;
            width: 90%;
            margin-top: 10px;
            box-sizing: border-box;
        }

        #setName {
            margin-top: 10px;
            padding: 8px 16px;
            background: #28a745;
            border: none;
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
        }

        #errorMsg {
            color: red;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            #chat-container {
                padding: 5px;
            }

            #message {
                padding: 8px;
            }

            #send {
                padding: 8px 16px;
            }
        }
    </style>
</head>

<body>
    <div id="chat-container">
        <div id="chat"></div>
        <div id="input-area">
            <input id="message" type="text" placeholder="Type a message..." />
            <button id="send">Send</button>
        </div>
    </div>

    <!-- Modal for username and room -->
    <div id="nameModal">
        <div id="nameModalContent">
            <!-- Add inside the modal -->
            <h2>Join or Create a Room</h2>

            <select id="roomSelect">
                <option value="">-- Select a room --</option>
            </select>
            <p style="margin: 5px 0;">or create new:</p>
            <input id="roomInput" type="text" placeholder="New room name (optional)" />

            <input id="nameInput" type="text" placeholder="Your name" />
            <br />
            <button id="setName">Enter Chat</button>
            <div id="errorMsg"></div>


        </div>
    </div>

    <script>
        let ws;
        let username = "";
        let roomName = "";

        const chat = document.getElementById("chat");
        const messageInput = document.getElementById("message");
        const sendButton = document.getElementById("send");
        const nameModal = document.getElementById("nameModal");
        const nameInput = document.getElementById("nameInput");
        const roomInput = document.getElementById("roomInput");
        const setNameButton = document.getElementById("setName");
        const errorMsg = document.getElementById("errorMsg");

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = "#";
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xff;
                color += ("00" + value.toString(16)).substr(-2);
            }
            return color;
        }

        function appendMessage(messageData) {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message");
            msgDiv.classList.add(messageData.username === username ? "sent" : "received");

            const bubbleDiv = document.createElement("div");
            bubbleDiv.classList.add("bubble");

            const sender = messageData.username;
            const text = messageData.content;

            if (sender !== "System") {
                const senderColor = stringToColor(sender);
                bubbleDiv.style.backgroundColor = senderColor + "20";
                bubbleDiv.style.borderColor = senderColor;
            } else {
                bubbleDiv.style.backgroundColor = "#f8f9fa";
                bubbleDiv.style.borderColor = "#ced4da";
            }

            bubbleDiv.textContent = text;

            const timeSpan = document.createElement("div");
            timeSpan.classList.add("timestamp");
            const timestamp = new Date().toLocaleTimeString();
            timeSpan.textContent = `${sender} - ${timestamp}`;

            msgDiv.appendChild(bubbleDiv);
            msgDiv.appendChild(timeSpan);
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
        }

        function connectWebSocket(room) {
            ws = new WebSocket(`ws://${window.location.host}/ws?room=${room}`);

            ws.onopen = () => {
                console.log("Connected to WebSocket.");
                const name = nameInput.value.trim();
                if (name !== "") {
                    const msg = { type: "setUsername", username: name };
                    ws.send(JSON.stringify(msg));
                }
            };

            ws.onmessage = function (evt) {
                try {
                    const messageData = JSON.parse(evt.data);
                    if (messageData.type === "error") {
                        errorMsg.textContent = messageData.content;
                    } else if (messageData.type === "chat") {
                        appendMessage(messageData);
                        if (username === "") {
                            username = nameInput.value.trim();
                            nameModal.style.display = "none";
                        }
                    }
                } catch (e) {
                    console.error("Invalid message format", evt.data);
                }
            };

            ws.onerror = err => {
                errorMsg.textContent = "WebSocket error. Try again later.";
                console.error("WebSocket error:", err);
            };
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (text === "") return;
            const msg = { type: "chat", content: text };
            ws.send(JSON.stringify(msg));
            messageInput.value = "";
        }

        // Fetch available rooms on load
        window.onload = async function () {
            try {
                const res = await fetch("/rooms");
                const rooms = await res.json();
                const roomSelect = document.getElementById("roomSelect");
                rooms.forEach(room => {
                    const opt = document.createElement("option");
                    opt.value = room;
                    opt.textContent = room;
                    roomSelect.appendChild(opt);
                });
            } catch (e) {
                console.error("Failed to fetch room list:", e);
            }
        };

        setNameButton.onclick = function () {
            const name = nameInput.value.trim();
            const selectedRoom = document.getElementById("roomSelect").value.trim();
            const customRoom = roomInput.value.trim();
            const finalRoom = customRoom || selectedRoom;

            if (name === "" || finalRoom === "") {
                errorMsg.textContent = "Please select or enter a room and enter your name.";
                return;
            }
            roomName = finalRoom;
            connectWebSocket(roomName);
        };


        sendButton.onclick = sendMessage;
        messageInput.addEventListener("keyup", function (e) {
            if (e.key === "Enter") sendMessage();
        });
    </script>
</body>

</html>